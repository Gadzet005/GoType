version: "3.9"

name: hsedb

services:
#  postgres:
#    image: postgres:14.8-alpine3.18
#    environment:
#      POSTGRES_DB: "gotypedb"
#      POSTGRES_USER: "gotype"
#      POSTGRES_PASSWORD: "gotypepwd"
##      PGDATA: "/var/lib/postgresql/data/pgdata"
#    volumes:
#      - .:/docker-entrypoint-initdb.d/docker-entrypoint-initdb.d
##      - gotypedb-data:/var/lib/postgresql/data
#    ports:
#      - "5432:5432"

    db-migrator:
      build:
        dockerfile: goose/Dockerfile
      command: ["postgresql://postgres:gotypepwd@db:5432/postgres", "up"]
      depends_on:
        db:
          condition: service_healthy

    db:
      restart: always
      image: postgres:16
      environment:
        POSTGRES_DB: "gotypedb"
        POSTGRES_USER: "gotype"
        POSTGRES_PASSWORD: "gotypepwd"
        PGDATA: "/var/lib/postgresql/data/pgdata"
        POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
      ports:
        - '5432:5432'
      volumes:
        - ./postgres-data:/var/lib/postgresql/data
      healthcheck:
        test: [ "CMD-SHELL", "pg_isready -U postgres -d postgres" ]
        interval: 10s
        timeout: 5s
        retries: 5
        start_period: 10s


#volumes:
#  habrdb-data: